*CASO 1*
--CREAR TABLA--
CREATE TABLE RECAUDACION_BONOS_MEDICOS (
RUT_MEDICO VARCHAR2(12) NOT NULL,
NOMBRE_MEDICO VARCHAR2(50) NOT NULL,
TOTAL_RECAUDADO NUMBER(10, 2) NOT NULL,
UNIDAD_MEDICA VARCHAR2(40) NOT NULL
);

--DATOS--
INSERT INTO RECAUDACION_BONOS_MEDICOS (RUT_MEDICO, NOMBRE_MEDICO, TOTAL_RECAUDADO, UNIDAD_MEDICA)
SELECT
m.rut_med || '-' || m.dv_run AS RUT_MEDICO,
m.pnombre || ' ' || m.apaterno || ' ' || m.amaterno AS NOMBRE_MEDICO,
SUM(bc.costo) AS TOTAL_RECAUDADO,
uc.nombre AS UNIDAD_MEDICA
FROM BONO_CONSULTA bc
JOIN MEDICO m ON bc.rut_med = m.rut_med
JOIN UNIDAD_CONSULTA uc ON m.uni_id = uc.uni_id
WHERE
EXTRACT(YEAR FROM bc.fecha_bono) = EXTRACT(YEAR FROM SYSDATE) - 1
AND m.car_id NOT IN (100, 500, 600)
GROUP BY m.rut_med, m.dv_run, m.pnombre, m.apaterno, m.amaterno, uc.nombre
ORDER BY TOTAL_RECAUDADO ASC;

--CONSULTA--
SELECT * FROM RECAUDACION_BONOS_MEDICOS ORDER BY TOTAL_RECAUDADO ASC;

*CASO 2*
SELECT
em.nombre AS Especialidad_Medica,
COUNT(bc.id_bono) AS Cantidad_Bonos,
SUM(CASE WHEN pg.fecha_pago IS NULL THEN bc.costo ELSE 0 END) AS Monto_Perdida,
MIN(bc.fecha_bono) AS Fecha_Bono,antiguo
CASE
WHEN pg.fecha_pago IS NULL THEN 'INCOBRABLE'
ELSE 'COBRABLE'
END AS Estado_De_Cobro
FROM BONO_CONSULTA bc
JOIN DET_ESPECIALIDAD_MED dem ON bc.rut_med = dem.rut_med AND bc.esp_id = dem.esp_id
JOIN ESPECIALIDAD_MEDICA em ON dem.esp_id = em.esp_id
LEFT JOIN PAGOS pg ON bc.id_bono = pg.id_bono
WHERE EXTRACT(YEAR FROM bc.fecha_bono) >= 2021
GROUP BY em.nombre, CASE WHEN pg.fecha_pago IS NULL THEN 'INCOBRABLE' ELSE 'COBRABLE' END
ORDER BY Monto_Perdida DESC;

*CASO 3*
--CREAR TABLA--
CREATE TABLE CANT_BONOS_PACIENTES_ANNIO (
ANNIO_CALCULO NUMBER(4) NOT NULL,
PAC_RUN NUMBER(8) NOT NULL,
DV_RUN VARCHAR2(1) NOT NULL,
EDAD NUMBER(3) NOT NULL,
CANTIDAD_BONOS NUMBER(7) NOT NULL,
MONTO_TOTAL_BONOS NUMBER(7) NOT NULL,
SISTEMA_SALUD VARCHAR2(100) NOT NULL
);

--DATOS--
WITH PromedioBonos AS (
SELECT ROUND(AVG(CANTIDAD_BONOS)) AS PromedioBonos
FROM CANT_BONOS_PACIENTES_ANNIO
WHERE ANNIO_CALCULO = EXTRACT(YEAR FROM SYSDATE) - 1
),
DatosPacientes AS (
SELECT
EXTRACT(YEAR FROM SYSDATE) AS ANNIO_CALCULO,
p.pac_run AS PAC_RUN,
p.dv_run AS DV_RUN,
FLOOR((SYSDATE - p.fecha_nacimiento) / 365.25) AS EDAD,
COUNT(DISTINCT bc.id_bono) AS CANTIDAD_BONOS,
SUM(DISTINCT COALESCE(bc.costo, 0)) AS MONTO_TOTAL_BONOS,
ss.descripcion AS SISTEMA_SALUD
FROM PACIENTE p
LEFT JOIN BONO_CONSULTA bc ON p.pac_run = bc.pac_run
AND EXTRACT(YEAR FROM bc.fecha_bono) = EXTRACT(YEAR FROM SYSDATE)
    LEFT JOIN SALUD s ON p.sal_id = s.sal_id
    LEFT JOIN SISTEMA_SALUD ss ON s.tipo_sal_id = ss.tipo_sal_id
    GROUP BY p.pac_run, p.dv_run, p.fecha_nacimiento, ss.descripcion
)
INSERT INTO CANT_BONOS_PACIENTES_ANNIO (ANNIO_CALCULO, PAC_RUN, DV_RUN, EDAD, CANTIDAD_BONOS, MONTO_TOTAL_BONOS, SISTEMA_SALUD)
SELECT
dp.ANNIO_CALCULO,
dp.PAC_RUN,
dp.DV_RUN,
dp.EDAD,
dp.CANTIDAD_BONOS,
dp.MONTO_TOTAL_BONOS,
dp.SISTEMA_SALUD
FROM DatosPacientes dp
CROSS JOIN PromedioBonos pb
WHERE dp.MONTO_TOTAL_BONOS <= pb.PromedioBonos + 10
ORDER BY dp.MONTO_TOTAL_BONOS DESC, dp.EDAD DESC;

--CONSULTA--
SELECT * FROM CANT_BONOS_PACIENTES_ANNIO
WHERE ANNIO_CALCULO = EXTRACT(YEAR FROM SYSDATE)
ORDER BY MONTO_TOTAL_BONOS DESC, EDAD DESC;